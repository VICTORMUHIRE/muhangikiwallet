{% load static %}
<style>


  .modal-content {
    border-radius: .5rem;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    min-height:60vh;
    max-height: 70vh;
    overflow-y: auto;
    padding: 1.5rem;
  }

  .step-header {
    display: flex !important;
    align-items: center !important;
    margin-bottom: 3rem;
  }

  .btn-link-back {
    color: #718096;
    padding: 0;
    display: flex; 
    align-items: center;
    width: 100%;
    text-decoration: none; 
    background: none;
    border: none; 
    cursor: pointer; 
  }

  .btn-link-back svg {
    width: 1.2rem;
    height: 1.2rem;
    margin-right: 0.5rem;
  }

  .progress-bar-container {
    width: 30%; /* Occuper l'autre moitié de la largeur */
    display: flex;
    align-items: center;
    height: 0.5rem;
    background-color: #e0e0e0;
    border-radius: 0.25rem;
    overflow: hidden;
  }

  .progress-bar {
    background-color: #fc9d1b;
    height: 100%;
    width: 0%;
    border-radius: 0.25rem;
    transition: width 0.3s ease-in-out;
  }

  .step {
    transition: opacity 0.3s ease-in-out, transform 0.3s ease;
    opacity: 0;
    transform: translateX(10px);
    display: none;
  }

  .step.active {
    display: block;
    opacity: 1;
    transform: translateX(0);
  }

  .card-option {
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    border: 1px solid #e0e0e0;
    border-radius: 0.75rem;
    padding: 0rem;
    height:5rem;
    margin-bottom: 0.5rem;
  }

  .card-option:hover {
    background-color: #f5f5f5;
    border-color: #ccc;
    transform: scale(1.02);
  }

  .icon {
    font-size: 1.2rem;
    margin-right: 0.5rem;
  }

  .provider-logo {
    max-height: 50px;
    object-fit: contain;
  }

  .img-fluid {
    max-width: 100%;
    height: auto;
  }

  @media (max-width: 576px) {
    h6, .form-label {
      font-size: 1rem;
    }
  }

  .number-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border-bottom: 1px solid #e0e0e0;
    cursor: pointer;
    transition: background-color 0.2s ease-in-out;
  }

  .number-option:last-child {
    border-bottom: none;
  }

  .number-option:hover {
    background-color: #f9f9f9;
  }

  .number-info {
    display: flex;
    align-items: center;
  }

  .number-icon {
    width: 24px;
    height: 24px;
    margin-right: 0.75rem;
    fill: #718096; /* Couleur de l'icône */
  }

  .number-details {
    display: flex;
    flex-direction: column;
  }

  .number-details .primary {
    font-size: 0.8rem;
    color: #a0aec0;
  }

  .arrow-icon {
    width: 20px;
    height: 20px;
    fill: #718096;
  }

  .step-tracker {
    display: flex;
    justify-content: space-between;
    align-items: center;
    
  }

  .step-dot {
    width: 2rem;
    height: 0.4rem;
    background-color: #e0e0e0;
    margin-left: .2rem;
    border-radius: .5rem;
    transition: background-color 0.3s ease-in-out;
  }

  .step-dot.active,
  .step-dot.completed {
    background-color: #fc9d1b;
  }


</style>


<div class="col-md-6 px-3">
  <div class="card border-0 rounded-2 shadow-sm">
    <div class="card-body p-4">
      <!-- Header Bienvenue -->
      <div class="d-flex align-items-center mb-4">
        <div>
          <h5 class="fw-bold mb-1">
            Bienvenue{% if membre.sexe == "F" %}e{% endif %}
            <span class="text-primary"
              >{{ user.membre.nom }}</span
            >
          </h5>
          <p class="text-muted small">Gérez vos fonds facilement.</p>
        </div>
      </div>

      <!-- Soldes -->
      <h6 class="text-muted small fw-semibold mb-3">Vos soldes actuels</h6>
      <div class="row">
      <div class="col-md-6 mb-3">
        <div class="card border rounded-3 shadow-sm">
          <div class="card-body p-3">
            <h6 class="text-muted mb-2">
              <i class="fas fa-dollar-sign me-2"></i> Balance USD
            </h6>
            <p class="h5 mb-0 text-success">
              {{ compte_usd|floatformat:2 }} USD
            </p>
          </div>
        </div>
      </div>
      <div class="col-md-6 mb-3">
        <div class="card border rounded-3 shadow-sm">
          <div class="card-body p-3">
            <h6 class="text-muted mb-2">
              <i class="fas fa-coins me-2"></i> Balance CDF
            </h6>
            <p class="h5 mb-0 text-primary">
              {{ compte_cdf|floatformat:2 }} CDF
            </p>
          </div>
        </div>
      </div>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <button
          class="btn btn-success btn-sm rounded-pill px-3"
          data-bs-toggle="modal"
          data-bs-target="#depositModal"
        >
          <i class="fas fa-arrow-alt-circle-up me-1"></i> Recharger
        </button>
        <button
          class="btn btn-danger btn-sm rounded-pill px-3"
          data-bs-toggle="modal"
          data-bs-target="#withdrawModal"
        >
          <i class="fas fa-arrow-alt-circle-down me-1"></i> Retirer
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="depositModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-md modal-fullscreen-sm-down">
    <div class="modal-content">
      <form method="post" action="{% url 'membres:rechargeCompte' %}" id="depositForm" style="display: flex; flex-direction: column; justify-content: space-between; min-height : 60vh;">
        {% csrf_token %}
        <div class="modal-body">
          <div id="stepsContainer">

            <div class="step active" data-step="1">
              <div class="step-header">
                <div class="step-tracker">
                  <div class="step-dot active"></div>
                  <div class="step-dot"></div>
                  <div class="step-dot"></div>
                  <div class="step-dot"></div>
                </div>
              </div>
              <h6 class="fw-semibold">1. Choisir un fournisseur</h6>
              <div class="row row-cols-md-3 g-1 g-md-3 mt-3" >
                <div class="col">
                  <button type="button" class="card card-option border rounded-3  d-flex align-items-center justify-content-center" onclick="selectProvider('AIRTEL'); goToStep(2)" data-provider="AIRTEL">
                    <img src="{% static "airtel.png" %}" alt="Airtel Money" class="img-fluid m-3 provider-logo">
                  </button>
                </div>
                <div class="col">
                  <button type="button" class="card card-option border rounded-3 d-flex align-items-center justify-content-center" onclick="selectProvider('MPESA'); goToStep(2)" data-provider="MPESA">
                    <img src="{% static "mpesa.png" %}" alt="M-PESA" class="img-fluid m-3 provider-logo">
                  </button>
                </div>
                <div class="col">
                  <button type="button" class="card card-option border rounded-3 d-flex align-items-center justify-content-center" onclick="selectProvider('ORANGE'); goToStep(2)" data-provider="ORANGE">
                    <img src="{% static "orange.png" %}" alt="Orange Money" class="img-fluid m-3 provider-logo">
                  </button>
                </div>
              
                <input type="hidden" name="fournisseur" id="fournisseur">
              </div>
            
              <div id="providerError" class="text-danger mt-2 d-none">Veuillez choisir un fournisseur.</div>
            </div>

            <div class="step" data-step="2">
              <div class="step-header">
                <button type="button" class="btn-link-back" onclick="goToStep(1)">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                  Retour
                </button>
                <div class="step-tracker">
                  <div class="step-dot completed"></div>
                  <div class="step-dot active"></div>
                  <div class="step-dot"></div>
                  <div class="step-dot"></div>
                </div>
              </div>
              <h6 class="fw-semibold mb-3">2. Sélectionner votre numéro</h6>
              <div class="list-group">
                <button type="button" class="number-option btn-link-back " onclick="selectNumero('{{membre.numero_telephone}}'); goToStep(4);">
                  <div class="number-info">
                    <i class="fas fa-mobile-alt number-icon"></i>
                    <div class="number-details">
                      <span>{{membre.numero_telephone}}</span>
                      <span class="primary">Numéro Principal</span>
                    </div>
                  </div>
                  <i class="fas fa-chevron-right arrow-icon"></i>
                </button>
                <button type="button" class="number-option btn-link-back" onclick="goToStep(3)">
                  <div class="number-info">
                    <i class="fas fa-plus-circle number-icon"></i>
                    <div class="number-details">
                      <span>Ajouter un autre numéro</span>
                    </div>
                  </div>
                  <i class="fas fa-chevron-right arrow-icon"></i>
                </button>
              </div>
              <input type="hidden" name="account_sender" id="account_sender">
              <div id="numeroError" class="text-danger mt-2 d-none">Veuillez sélectionner ou entrer un numéro de téléphone.</div>
            </div>

            <div class="step" data-step="3">
              <div class="step-header">
                <button type="button" class="btn-link-back" onclick="goToStep(2)">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                  </svg>
                  Retour
                </button>
                <div class="step-tracker">
                  <div class="step-dot completed"></div>
                  <div class="step-dot active"></div>
                  <div class="step-dot"></div>
                  <div class="step-dot"></div>
                </div>
              </div>
              <h6 class="fw-semibold mb-3">3. Entrer un nouveau numéro</h6>
              <div class="mb-3">
                <label for="newNumber" class="form-label">Nouveau numéro</label>
                <input type="tel" class="form-control" id="newNumber" placeholder="Ex: +243970000000">
              </div>
              <button type="button" class="btn btn-primary w-100" onclick="selectNumero(document.getElementById('newNumber').value); goToStep(4)">Suivant</button>
              <div id="newNumeroError" class="text-danger mt-2 d-none">Veuillez entrer un numéro de téléphone valide.</div>
            </div>

            <div class="step" data-step="4">
              <div class="step-header">
                <button type="button" class="btn-link-back" onclick="goToStep(2)">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                  </svg>
                  Retour
                </button>
                <div class="step-tracker">
                  <div class="step-dot completed"></div>
                  <div class="step-dot completed"></div>
                  <div class="step-dot active"></div>
                  <div class="step-dot"></div>
                </div>
              </div>
              <h6 class="fw-semibold mb-3">4. Choisir la devise et entrer le montant</h6>
              <div class="mb-3">
                <label for="{{ form.devise.id_for_label }}" class="form-label">{{ form.devise.label }}</label>
                {{ form.devise }}
                {% if form.devise.errors %}
                  <div class="alert alert-danger mt-2">{{ form.devise.errors }}</div>
                {% endif %}
              </div>
              <div class="mb-3">
                <label for="{{ form.montant.id_for_label }}" class="form-label">{{ form.montant.label }}</label>
                {{ form.montant }}
                {% if form.montant.errors %}
                  <div class="alert alert-danger mt-2">{{ form.montant.errors }}</div>
                {% endif %}
              </div>
              <button type="button" class="btn btn-primary w-100" onclick="validateAmountAndCurrency()">Suivant</button>
              <div id="montantDeviseError" class="text-danger mt-2 d-none">Veuillez choisir la devise et entrer un montant valide.</div>
            </div>

            <div class="step" data-step="5">
              <div class="step-header">
                <button type="button" class="btn-link-back" onclick="goToStep(4)">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                  </svg>
                  Retour
                </button>
                <div class="step-tracker">
                  <div class="step-dot completed"></div>
                  <div class="step-dot completed"></div>
                  <div class="step-dot completed"></div>
                  <div class="step-dot active"></div>
                </div>
              </div>
              <h6 class="fw-semibold mb-3">5. Confirmation de la transaction</h6>
              <div class="mb-3">
                <p>Vous allez recharger <strong id="confirmAmount"></strong>, <br>frais <strong id="fraisRetrais"></strong> <span id="confirmCurrency"> <br> </span> sur le numéro <strong id="confirmNumber"></strong> via <strong id="confirmProvider"></strong>. </p>
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">Mot de passe</label>
                <input type="password" class="form-control" id="password" name="password" placeholder="Votre mot de passe">
              </div>
              <div id="passwordError" class="text-danger mt-2 d-none">Veuillez entrer votre mot de passe.</div>
              <button type="submit" class="btn btn-success w-100" onclick="return validateFinalStep()">Confirmer et procéder</button>
            </div>

          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary btn-sm rounded-3"
            data-bs-dismiss="modal"
          >
            Annuler
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  let currentStep = 1;
  let selectedProvider = null;
  let selectedNumero = null;

  function goToStep(step) {
    document.querySelectorAll('.step').forEach((el) => {
      el.classList.remove('active');
    });
    const target = document.querySelector(`.step[data-step="${step}"]`);
    if (target) target.classList.add('active');

    currentStep = step;
  }

  function selectProvider(provider) {
    selectedProvider = provider;
    document.getElementById('fournisseur').value = provider;
    document.getElementById('confirmProvider').textContent = provider;
    document.getElementById('providerError').classList.add('d-none');
  }

  function selectNumero(numero) {
    selectedNumero = numero;
    document.getElementById('account_sender').value = numero;
    document.getElementById('confirmNumber').textContent = numero;
    document.getElementById('numeroError').classList.add('d-none');
    document.getElementById('newNumeroError').classList.add('d-none');
  }

  function validateProvider() {
    if (!selectedProvider) {
      document.getElementById('providerError').classList.remove('d-none');
      return false;
    }
    return true;
  }

  function validateNumero() {
    if (!selectedNumero || selectedNumero.length < 9) {
      document.getElementById('numeroError').classList.remove('d-none');
      return false;
    }
    return true;
  }

  function validateNewNumero() {
    const newNumberInput = document.getElementById('newNumber').value;
    if (!newNumberInput || newNumberInput.length < 9) {
      document.getElementById('newNumeroError').classList.remove('d-none');
      return false;
    }
    selectNumero(newNumberInput);
    return true;
  }

  function validateAmountAndCurrency() {
    const amountInput = document.getElementById('id_montant').value;
    const currencySelect = document.getElementById('id_devise').value;
    if (!amountInput || parseFloat(amountInput) <= 0 || !currencySelect) {
      document.getElementById('montantDeviseError').classList.remove('d-none');
      return false;
    }
    document.getElementById('confirmAmount').textContent = amountInput;
    document.getElementById('confirmCurrency').textContent = currencySelect;
    // document.getElementById('fraisRetrais').textContent = (0.035*parseFloat(amountInput));
    goToStep(5);
    return true;
  }

  function validateFinalStep() {
    const passwordInput = document.getElementById('password').value;
    if (!passwordInput) {
      document.getElementById('passwordError').classList.remove('d-none');
      return false;
    }
    return true;
  }

  document.getElementById('depositForm').addEventListener('submit', function(event) {
    let formIsValid = true;

    if (!validateProvider()) {
      formIsValid = false;
      goToStep(1); // Retourner à l'étape du fournisseur
    } else if (!selectedNumero || selectedNumero.length < 9) {
      formIsValid = false;
      goToStep(2); // Retourner à l'étape du numéro
    } else if (!document.getElementById('id_montant').value || parseFloat(document.getElementById('id_montant').value) <= 0 || !document.getElementById('id_devise').value) {
      formIsValid = false;
      goToStep(4); // Retourner à l'étape du montant/devise
    } else if (!document.getElementById('password').value) {
      formIsValid = false;
      goToStep(5); // Retourner à l'étape du mot de passe
    }

    if (!formIsValid) {
      event.preventDefault(); // Empêcher la soumission si une validation échoue
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
    goToStep(1);
  });
</script>