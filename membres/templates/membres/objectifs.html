{% extends 'membres/base.html' %}
{% load humanize %}
{% load objectifFilter %}
{% block title %}Mes Objectifs{% endblock %}
{% block content %}

<style>
  .accordion-button::after {
      display: none !important;
  }

  .progress-circle-container {
    width: 50px;
    height: 50px;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
  }
.progress-circle {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: conic-gradient(
    #feaf3d var(--progress-percentage),
    #d3d3d3 var(--progress-percentage) 100%
  );
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 0.8rem;
  font-weight: bold;
  color: #6c757d;
  z-index: 10;
}
  .progress-circle::before {
    content: '';
    position: absolute;
    top: 5px;
    left: 5px;
    width: calc(100% - 10px);
    height: calc(100% - 10px);
    border-radius: 50%;
    background-color: #fafbfc;
    z-index: -1;
  }

  .objectif-item {
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    margin-bottom: 0.5rem;
    overflow: hidden;
  }

  .objectif-header {
    background-color: #fafbfc;
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }

  .objectif-header:hover {
    background-color: #e9ecef;
  }

  .objectif-actions a, .objectif-actions button {
    margin-left: 0.5rem;
  }

  .objectif-details {
    padding: 1rem;
    background-color: #fff;
  }

  /* Style spécifique pour les objectifs retirés */
  .objectif-item.retire {
    opacity: 0.7; /* Diminue l'opacité pour indiquer qu'il est retiré */
    border-color: #6c757d; /* Change la couleur de la bordure */
  }

  .objectif-header.retire {
    background-color: #e9ecef; /* Légèrement grisé */
    color: #6c757d; /* Texte grisé */
    text-decoration: line-through; /* Barre le nom de l'objectif */
  }

  .progress-circle-container.retire {
    display: none; /* Cache le cercle de progression */
  }

  .fa-chevron-down.retire {
    opacity: 0.5; /* Diminue l'opacité de la flèche */
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .col-md-8, .col-md-4 {
      flex-basis: 100%;
      max-width: 100%;
      text-align: center !important;
      margin-bottom: 0.5rem;
    }
    .objectif-header {
      flex-direction: column;
      align-items: flex-start;
    }
    .objectif-actions {
      margin-top: 0.5rem;
    }
    .objectif-actions a, .objectif-actions button {
      margin-left: 0;
      margin-right: 0.5rem;
    }
  }
</style>

<div class="container-fluid p-3 p-md-4 rounded-3" style="background-color: #fff; min-height: 100%;">

  {% for message in messages %}
  <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endfor %}

  <div class="mb-4">
    <div class="card rounded p-4 border">
      <div class="row align-items-end">
        <div class="col-md-8">
          <h5 class="mb-2 fw-semibold text-dark"> Aperçu de mes Objectifs</h5>
          <p class="mb-1 fs-6 text-muted">
            Total disponible (CDF) : <strong class="fw-bold">{{ solde_objectifs_CDF|intcomma }} FC</strong>
          </p>
          <p class="mb-0 fs-6 text-muted">
            Total disponible (USD) : <strong class="fw-bold">{{ solde_objectifs_USD|intcomma }} $</strong>
          </p>
          <p class="mb-0 mt-2 fs-6 text-muted">
            Objectifs : <strong class="fw-bold">{{ objectifs|length }}</strong> actifs,
            <strong class="fw-bold">{{ objectifs|objectif_statut_count:'Atteint' }}</strong> atteints,
            <strong class="fw-bold">{{ objectifs|objectif_statut_count:'Annulé' }}</strong> annulés,
            <strong class="fw-bold">{{ objectifs|objectif_statut_count:'Retiré' }}</strong> retirés
          </p>
          </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
          <button type="button" class="btn btn-success btn-sm rounded py-2 px-3 shadow-sm text-white" data-bs-toggle="modal" data-bs-target="#ajouterObjectifModal">
            <i class="fas fa-plus me-2"></i>Nouveau objectif
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="objectifsList">
    <h6 class="mb-3 fw-semibold"><i class="fas fa-list-ul me-2 text-dark"></i> Liste des Objectifs</h6>
    {% for objectif in objectifs %}
    {% with progress_percentage=objectif.montant|pourcentage:objectif.montant_cible|stringformat:".0f" %}
    {% with objectif.nom|slugify as objectif_slug %}
    <div class="objectif-item mb-3 {% if objectif.statut == 'Retiré' %}retire{% endif %}">
      <div class="objectif-header d-flex justify-content-between align-items-center {% if objectif.statut == 'Retiré' %}retire{% endif %}" data-bs-toggle="collapse" href="#collapse{{ objectif_slug }}" role="button" aria-expanded="false" aria-controls="collapse{{ objectif_slug }}" style="cursor: pointer;">
        <div class="d-flex align-items-center gap-2">
          {% if objectif.statut == 'Atteint' %}
          <i class="fas fa-check-circle text-success"></i>
          {% elif objectif.statut == 'En cours' %}
          <i class="fas fa-hourglass-half text-warning"></i>
          {% elif objectif.statut == 'Annulé' or objectif.statut == 'Epuisé' %}
          <i class="fas fa-times-circle text-danger"></i>
          {% elif objectif.statut == 'Retiré' %}
          <i class="fas fa-box-open text-secondary"></i>
          {% else %}
          <i class="fas fa-flag-checkered text-primary"></i>
          {% endif %}
          <span class="fw-semibold">{{ objectif.nom }}</span>
          <small class="text-muted">({{ objectif.montant|intcomma }} / {{ objectif.montant_cible|intcomma }} {{ objectif.devise }})</small>
        </div>
        <div class="d-flex align-items-center gap-3 {% if objectif.statut == 'Retiré' %}retire{% endif %}">
          {% if objectif.statut != 'Retiré' %}
              <div class="progress-circle-container">
                  <div class="progress-circle" style="--progress-percentage: {{ progress_percentage }}%; --progress-color: {% if progress_percentage|floatformat:0 >= 100 %}green{% elif progress_percentage|floatformat:0 > 50 %}orange{% else %}red{% endif %};">
                      {{ progress_percentage }}%
                  </div>
              </div>
          {% endif %}
          <i class="fas fa-chevron-down text-muted {% if objectif.statut == 'Retiré' %}retire{% endif %}"></i>
        </div>
      </div>
      <div class="collapse" id="collapse{{ objectif_slug }}" data-bs-parent="#objectifsList">
        <div class="objectif-details">
          <ul class="mb-0 text-muted">
            <li><small><strong>Montant cible :</strong> {{ objectif.montant_cible|intcomma }} {{ objectif.devise }}</small></li>
            <li><small><strong>Montant déposé :</strong> {{ objectif.montant|intcomma }} {{ objectif.devise }}</small></li>
            <li><small><strong>Date de création :</strong> {{ objectif.date_creation|date:"d/m/Y" }}</small></li>
            <li><small><strong>Date d'échéance :</strong> {{ objectif.date_fin|date:"d/m/Y" }}</small></li>
            {% if objectif.description %}
            <li><small><strong>Description :</strong> {{ objectif.description }}</small></li>
            {% endif %}
            <li>
              <small><strong>Statut :</strong>
                <span class="badge {% if objectif.statut == 'Atteint' %}bg-success{% elif objectif.statut == 'En cours' %}bg-warning{% elif objectif.statut == 'Annulé' or objectif.statut == 'Epuisé' %}bg-danger{% elif objectif.statut == 'Retiré' %}bg-secondary{% else %}bg-info{% endif %} rounded-pill">
                  {{ objectif.statut }}
                </span>
              </small>
            </li>
          </ul>

          <div class="d-flex justify-content-end gap-2 mt-3 objectif-actions">
            {% if objectif.statut not in 'Atteint Retiré Annulé Epuisé' %}
            <button type="button" class="btn btn-danger btn-sm rounded-pill"
                    data-bs-toggle="modal"
                    data-bs-target="#AnnulereObjectifModalLabel{{ objectif.id }}">
              <i class="fas fa-ban me-1"></i>Annuler
            </button>
            {% endif %}
            {% if objectif.statut == 'En cours' %}
                <button type="button" class="btn btn-primary btn-sm rounded-pill"
                        data-bs-toggle="modal"
                        data-bs-target="#depotObjectifModal{{ objectif.id }}"
                        data-objectif-id="{{ objectif.id }}"
                        data-objectif-nom="{{ objectif.nom }}"
                        data-objectif-devise="{{ objectif.devise }}">
                    <i class="fas fa-upload me-1"></i>Déposer
                </button>
            {% elif objectif.statut == 'Atteint' %}
            <button type="button" class="btn btn-success btn-sm rounded-pill"
                    data-bs-toggle="modal"
                    data-bs-target="#retraitObjectifModal{{ objectif.id }}">
              <i class="fas fa-download me-1"></i>Retirer
            </button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% include "membres/components/depot_objectif.html" with objectif=objectif %}


    {% endwith %}
    {% endwith %}
    {% empty %}
    <div class="alert alert-info" role="alert">
      Vous n'avez pas encore d'objectifs définis. Cliquez sur "Nouveau objectif" pour en créer un.
    </div>
    {% endfor %}


  </div>
</div>

{% include "membres/components/ajouter_objectif.html" with form=form %}
{% for objectif in objectifs %}
{% include "membres/components/annuler_objectif.html" with objectif=objectif %}
{% include "membres/components/retrait_objectif.html" with objectif=objectif %}
{% endfor %}

{% endblock %}